{% extends 'base.html' %}
{% load static humanize %}

{% block title %}Feed | Social Sphere{% endblock %}

{% block content %}
<div class="flex flex-col space-y-8">

  {# — STORIES ROW — #}
  <div class="overflow-x-auto">
    <div class="flex space-x-4 py-4">
      {% for u in followings %}
        <div class="flex flex-col items-center w-20">
          <a href="{{ u.get_absolute_url }}">
            {% if u.photo %}
              <img src="{{ u.photo.url }}" alt="{{ u.username }}"
                   class="w-16 h-16 rounded-full border-2 border-purple-400 object-cover"/>
            {% else %}
              <div class="w-16 h-16 rounded-full bg-zinc-700 flex items-center justify-center
                          border-2 border-purple-400 text-zinc-300 uppercase text-xl">
                {{ u.username|first }}
              </div>
            {% endif %}
          </a>
          <span class="mt-1 text-xs text-zinc-300 truncate">{{ u.username }}</span>
        </div>
      {% empty %}
        <p class="text-zinc-500 px-4">No stories yet.</p>
      {% endfor %}
    </div>
  </div>

  {# — TAG FILTER INFO — #}
  {% if tag %}
    <div class="mb-4 text-zinc-200">
      Showing posts tagged
      <span class="font-semibold text-purple-400">#{{ tag.name }}</span>
      <a href="{% url 'social:post_list' %}"
         class="ml-2 text-sm text-zinc-400 hover:underline">Clear filter</a>
    </div>
  {% endif %}

  {# — MAIN GRID: FEED + SIDEBAR — #}
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    {# — FEED COLUMN — #}
    <div class="lg:col-span-2 space-y-8" id="postContainer">
      {% include 'post/feed_ajax.html' with posts=posts %}

      {# — Skeleton Loader — #}
      <div id="skeletonContainer" class="space-y-6 mt-6 animate-pulse">
        {% for _ in "123456"|make_list %}
          <div class="bg-zinc-700 rounded-lg p-4 space-y-3">
            <div class="h-8 w-8 rounded-full bg-zinc-600"></div>
            <div class="h-48 bg-zinc-600 rounded"></div>
            <div class="h-4 bg-zinc-600 rounded w-3/4"></div>
            <div class="h-4 bg-zinc-600 rounded w-1/2"></div>
          </div>
        {% endfor %}
      </div>

      {# — Infinite Scroll Trigger — #}
      <div id="loader" class="my-6 text-center hidden">
        <svg class="animate-spin h-8 w-8 text-purple-400 mx-auto"
             xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8v8H4z"/>
        </svg>
      </div>
    </div>

    {# — RIGHT SIDEBAR — #}
    <aside class="hidden lg:block bg-zinc-800 rounded-lg p-6 space-y-6">
      <!-- Profile Card -->
      <div class="flex items-center space-x-4">
        {% if user.photo %}
          <img src="{{ user.photo.url }}" class="w-12 h-12 rounded-full object-cover"/>
        {% else %}
          <div class="w-12 h-12 rounded-full bg-zinc-700 flex items-center justify-center
                      text-zinc-300 uppercase text-lg">
            {{ user.username|first }}
          </div>
        {% endif %}
        <div>
          <p class="font-semibold text-zinc-100">{{ user.get_full_name }}</p>
          <p class="text-zinc-400 text-sm">@{{ user.username }}</p>
          {% if user.bio %}
            <p class="text-zinc-400 text-xs mt-1">{{ user.bio|truncatechars:50 }}</p>
          {% endif %}
        </div>
      </div>

      <!-- Suggestions -->
      <div>
        <h2 class="font-semibold text-zinc-300 text-sm mb-3">Suggested for you</h2>
        <ul class="space-y-3">
          {% for sug in suggestions %}
            <li class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                {% if sug.photo %}
                  <img src="{{ sug.photo.url }}" class="w-8 h-8 rounded-full object-cover"/>
                {% else %}
                  <div class="w-8 h-8 rounded-full bg-zinc-700 flex items-center justify-center
                              text-zinc-300 uppercase text-sm">
                    {{ sug.username|first }}
                  </div>
                {% endif %}
                <div>
                  <p class="text-zinc-100 text-sm">{{ sug.username }}</p>
                  <p class="text-zinc-400 text-xs">
                    {{ sug.bio|default:"No bio"|truncatechars:30 }}
                  </p>
                </div>
              </div>
              <button class="suggest-follow-btn text-purple-400 text-xs font-semibold hover:text-purple-300"
                      data-user-id="{{ sug.id }}">
                Follow
              </button>
            </li>
          {% empty %}
            <li class="text-zinc-500 text-sm">No suggestions right now.</li>
          {% endfor %}
        </ul>
      </div>
    </aside>

  </div>
</div>

{# — DETAIL MODAL WRAPPER — #}
<div id="detailModal"
     class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-zinc-900 text-zinc-100 w-full max-w-[90vw] max-h-[90vh]
              relative rounded-lg overflow-hidden flex">  {# ← مهم: اینجا flex-row #}
    <button id="closeModal"
            class="absolute top-4 right-4 text-zinc-400 hover:text-zinc-100 text-2xl z-10">
      &times;
    </button>
    <div id="modalContent" class="flex-1 overflow-hidden flex"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script>
    window.socialUrls = {
      likeUrl:   "{% url 'social:like_post' %}",
      saveUrl:   "{% url 'social:save_post' %}",
      followUrl: "{% url 'social:user_follow' %}",
      inboxUrl:  "{% url 'social:inbox' %}"
    };
  </script>
  <script src="{% static 'js/feed.js' %}" defer></script>
{% endblock %}
