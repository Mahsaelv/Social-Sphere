{% extends 'base.html' %}
{% load static humanize %}

{% block title %}Explore | Social Sphere{% endblock %}

{% block content %}
<section class="pb-10">

  {# — SEARCH BOX برای جستجوی تگ‌ها — #}
  <form method="get" class="mb-6">
    <div class="relative w-full max-w-md">
      <input
        type="text"
        name="q"
        value="{{ q }}"
        placeholder="Search tags..."
        class="w-full pl-4 pr-10 py-2 rounded-lg bg-zinc-700 text-zinc-100
               placeholder-zinc-500 focus:outline-none focus:ring-2 focus:ring-purple-400"
      />
      <button type="submit"
              class="absolute inset-y-0 right-0 flex items-center pr-3 text-purple-400 hover:text-purple-300 transition">
        🔍
      </button>
    </div>
  </form>

{#  <h1 class="text-2xl font-bold text-purple-400 mb-6">Explore</h1>#}

  {# نمایش نام تگ فعال یا عبارت جستجو (اختیاری) #}
  {% if tag %}
    <div class="mb-4 text-zinc-200">
      Showing posts tagged
      <span class="font-semibold text-purple-400">#{{ tag.name }}</span>
      <a href="{% url 'social:explore' %}"
         class="ml-2 text-sm text-zinc-400 hover:underline">
        Clear filter
      </a>
    </div>
  {% elif q %}
    <div class="mb-4 text-zinc-200">
      Search results for
      <span class="font-semibold text-purple-400">{{ q }}</span>
      <a href="{% url 'social:explore' %}"
         class="ml-2 text-sm text-zinc-400 hover:underline">
        Clear search
      </a>
    </div>
  {% endif %}

  {# Posts Grid #}
  <div id="postContainer" class="grid grid-cols-3 gap-4">
    {% for post in posts %}
      <div class="bg-zinc-800 rounded-lg overflow-hidden">
        <a href="{{ post.get_absolute_url }}"
           class="block w-full aspect-square overflow-hidden">
          {% with image=post.images.first %}
            {% if image %}
              <img src="{{ image.image_file.url }}"
                   alt="{{ post.description|truncatechars:20 }}"
                   class="object-cover w-full h-full transform hover:scale-105 transition" />
            {% else %}
              <div class="flex items-center justify-center h-full text-zinc-500">
                No Image
              </div>
            {% endif %}
          {% endwith %}
        </a>
        <div class="p-4">
          <p class="font-semibold text-sm text-zinc-100 mb-1">{{ post.author.username }}</p>
          <p class="text-zinc-400 text-sm truncate mb-2">{{ post.description }}</p>
          <div class="flex justify-between text-zinc-500 text-xs mb-2">
            <span>{{ post.total_likes }} likes</span>
            <span>{{ post.comments.count }} comments</span>
          </div>

          {# تگ‌ها زیر پست #}
          {% if post.tags.all %}
            <div class="flex flex-wrap">
              {% for t in post.tags.all %}
                <a href="{% url 'social:explore_by_tag' t.slug %}"
                   class="text-purple-400 text-sm hover:underline mr-2 mb-1">
                  #{{ t.name }}
                </a>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p class="text-zinc-500 col-span-3">No posts to explore.</p>
    {% endfor %}
  </div>

  {# Skeleton Loader #}
  <div id="skeletonContainer" class="grid grid-cols-3 gap-4 mt-6 animate-pulse">
    {% for _ in "123456"|make_list %}
      <div class="bg-zinc-700 rounded-lg p-4 space-y-3">
        <div class="h-48 bg-zinc-600 rounded"></div>
        <div class="h-4 bg-zinc-600 rounded w-3/4"></div>
        <div class="h-4 bg-zinc-600 rounded w-1/2"></div>
      </div>
    {% endfor %}
  </div>

  {# Infinite Scroll Trigger #}
  <div id="loader" class="my-6 text-center hidden">
    <svg class="animate-spin h-8 w-8 text-purple-400 mx-auto"
         xmlns="http://www.w3.org/2000/svg" fill="none"
         viewBox="0 0 24 24" stroke="currentColor">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke-width="4"/>
      <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8v8H4z"/>
    </svg>
  </div>
</section>

<script>
// Infinite scroll for Explore
let page = 2;
const postContainer = document.getElementById('postContainer');
const skeleton      = document.getElementById('skeletonContainer');
const loader        = document.getElementById('loader');
const observer      = new IntersectionObserver(entries => {
  if (entries[0].isIntersecting) {
    observer.unobserve(loader);
    loader.classList.remove('hidden');
    fetch(`?page=${page}&q={{ q|urlencode }}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.text())
    .then(html => {
      if (page === 2 && skeleton) skeleton.remove();
      loader.classList.add('hidden');
      postContainer.insertAdjacentHTML('beforeend', html);
      page++;
      observer.observe(loader);
    });
  }
}, { rootMargin: '0px 0px 200px 0px' });
observer.observe(loader);
</script>
{% endblock %}
